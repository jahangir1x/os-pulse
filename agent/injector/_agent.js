ðŸ“¦
10443 /src/index.js
âœ„
var l=class{info(e){console.log(`[INFO] ${e}`)}error(e){console.log(`[ERROR] ${e}`)}debug(e){console.log(`[DEBUG] ${e}`)}logFileOperation(e,t){console.log(`
[${e}]`),console.log(`Path: ${t.filePath||"Unknown"}`),console.log(`Bytes: ${t.bytesTransferred}`),t.content&&console.log(`Content: ${t.content}`),console.log(`Timestamp: ${t.timestamp}`)}logProcessCreation(e,t){console.log(`
[${e}]`),console.log(`Status: ${t.status>=0?"SUCCESS":"FAILED"} (0x${t.status.toString(16).padStart(8,"0")})`),t.processHandle&&console.log(`Process Handle: 0x${t.processHandle.toString(16)}`),t.threadHandle&&console.log(`Thread Handle: 0x${t.threadHandle.toString(16)}`),t.imagePath&&console.log(`Image Path: ${t.imagePath}`),t.commandLine&&console.log(`Command Line: ${t.commandLine}`),t.currentDirectory&&console.log(`Current Directory: ${t.currentDirectory}`),t.parentProcess&&console.log(`Parent Process: 0x${t.parentProcess.toString(16)}`),t.flags!==void 0&&console.log(`Flags: 0x${t.flags.toString(16)}`),t.sectionHandle&&console.log(`Section Handle: 0x${t.sectionHandle.toString(16)}`),console.log(`Timestamp: ${t.timestamp}`)}};function P(o){try{let e=Process.getModuleByName("kernel32.dll").findExportByName("GetFinalPathNameByHandleW");if(!e)return null;let t=new NativeFunction(e,"uint32",["pointer","pointer","uint32","uint32"]),r=1024,s=Memory.alloc(r*2);return t(o,s,r,0)>0?s.readUtf16String():null}catch{return null}}function p(o){if(o.isNull())return null;try{let e=o.readU16(),t=o.add(2).readU16(),r=o.add(8).readPointer();return r.isNull()||e===0?null:r.readUtf16String(e/2)}catch{return null}}function N(o){if(o.isNull())return{imagePath:null,commandLine:null,currentDirectory:null};try{let e=o.add(96),t=o.add(112),r=o.add(56);return{imagePath:p(e),commandLine:p(t),currentDirectory:p(r)}}catch{return{imagePath:null,commandLine:null,currentDirectory:null}}}function y(o,e){try{let t=o.readByteArray(e);if(!t)return"<no data>";let r=new Uint8Array(t),s=[];for(let n=0;n<r.length;n++)s.push(r[n].toString(16).padStart(2,"0").toUpperCase());return s.join(" ")}catch{return"<error reading data>"}}function m(o){return o>=0}var d=class{logger;config;eventSender;constructor(e,t,r){this.logger=e,this.config=t,this.eventSender=r}initialize(){if(!this.config.enableFileOperations){this.logger.debug("File operations monitoring disabled");return}this.hookWriteFile(),this.hookReadFile()}hookWriteFile(){let e=Process.getModuleByName("kernel32.dll").findExportByName("WriteFile");if(!e){this.logger.error("WriteFile export not found!");return}let t=this;Interceptor.attach(e,{onEnter:function(r){this.handle=r[0],this.buffer=r[1],this.bytesToWrite=r[2].toInt32()},onLeave:function(r){r.toInt32()!==0&&t.handleWriteFileSuccess(this)}}),this.logger.info("Hooked WriteFile")}handleWriteFileSuccess(e){try{let t=P(e.handle),r;e.bytesToWrite<=this.config.maxContentLength?r=y(e.buffer,e.bytesToWrite):r=`<data too large: ${e.bytesToWrite} bytes>`;let s={handle:e.handle,filePath:t,bytesTransferred:e.bytesToWrite,content:r,timestamp:new Date().toISOString()};this.logger.logFileOperation("WriteFile",s),this.eventSender.sendFileOperation("WriteFile",s)}catch(t){this.logger.error(`Error processing WriteFile: ${t}`)}}hookReadFile(){let e=Process.getModuleByName("kernel32.dll").findExportByName("ReadFile");if(!e){this.logger.error("ReadFile export not found!");return}let t=this;Interceptor.attach(e,{onEnter:function(r){this.handle=r[0],this.buffer=r[1],this.bytesToRead=r[2].toInt32(),this.lpNumberOfBytesRead=r[3]},onLeave:function(r){r.toInt32()!==0&&t.handleReadFileSuccess(this)}}),this.logger.info("Hooked ReadFile")}handleReadFileSuccess(e){try{let t=P(e.handle),r=0;e.lpNumberOfBytesRead.isNull()||(r=e.lpNumberOfBytesRead.readU32());let s;r>0&&r<=this.config.maxContentLength?s=y(e.buffer,r):r>this.config.maxContentLength&&(s=`<data too large: ${r} bytes>`);let n={handle:e.handle,filePath:t,bytesTransferred:r,content:s,timestamp:new Date().toISOString()};this.logger.logFileOperation("ReadFile",n),this.eventSender.sendFileOperation("ReadFile",n)}catch(t){this.logger.error(`Error processing ReadFile: ${t}`)}}};var h=class{logger;config;eventSender;constructor(e,t,r){this.logger=e,this.config=t,this.eventSender=r}initialize(){if(!this.config.enableProcessCreation){this.logger.debug("Process creation monitoring disabled");return}this.hookNtCreateUserProcess(),this.hookNtCreateProcess(),this.hookNtCreateProcessEx()}hookNtCreateUserProcess(){let e=Process.getModuleByName("ntdll.dll").findExportByName("NtCreateUserProcess");if(!e){this.logger.error("NtCreateUserProcess export not found!");return}let t=this;Interceptor.attach(e,{onEnter:function(r){if(this.processHandle=r[0],this.threadHandle=r[1],this.processParameters=r[8],!this.processParameters.isNull()){let s=N(this.processParameters);this.imagePath=s.imagePath,this.commandLine=s.commandLine,this.currentDirectory=s.currentDirectory}},onLeave:function(r){t.handleNtCreateUserProcessResult(this,r)}}),this.logger.info("Hooked NtCreateUserProcess")}handleNtCreateUserProcessResult(e,t){try{let r=t.toInt32(),s,n;if(m(r))try{e.processHandle.isNull()||(s=e.processHandle.readPointer()),e.threadHandle.isNull()||(n=e.threadHandle.readPointer())}catch(S){this.logger.error(`Error reading handles: ${S}`)}let c={processHandle:s,threadHandle:n,imagePath:e.imagePath,commandLine:e.commandLine,currentDirectory:e.currentDirectory,status:r,timestamp:new Date().toISOString()};this.logger.logProcessCreation("NtCreateUserProcess",c),this.eventSender.sendProcessCreation("NtCreateUserProcess",c)}catch(r){this.logger.error(`Error processing NtCreateUserProcess: ${r}`)}}hookNtCreateProcess(){let e=Process.getModuleByName("ntdll.dll").findExportByName("NtCreateProcess");if(!e){this.logger.error("NtCreateProcess export not found!");return}let t=this;Interceptor.attach(e,{onEnter:function(r){this.processHandle=r[0],this.parentProcess=r[3],this.sectionHandle=r[5]},onLeave:function(r){t.handleNtCreateProcessResult(this,r)}}),this.logger.info("Hooked NtCreateProcess")}handleNtCreateProcessResult(e,t){try{let r=t.toInt32(),s;if(m(r))try{e.processHandle.isNull()||(s=e.processHandle.readPointer())}catch(c){this.logger.error(`Error reading process handle: ${c}`)}let n={processHandle:s,parentProcess:e.parentProcess,sectionHandle:e.sectionHandle,status:r,timestamp:new Date().toISOString()};this.logger.logProcessCreation("NtCreateProcess",n),this.eventSender.sendProcessCreation("NtCreateProcess",n)}catch(r){this.logger.error(`Error processing NtCreateProcess: ${r}`)}}hookNtCreateProcessEx(){let e=Process.getModuleByName("ntdll.dll").findExportByName("NtCreateProcessEx");if(!e){this.logger.error("NtCreateProcessEx export not found!");return}let t=this;Interceptor.attach(e,{onEnter:function(r){this.processHandle=r[0],this.parentProcess=r[3],this.flags=r[4].toInt32(),this.sectionHandle=r[5]},onLeave:function(r){t.handleNtCreateProcessExResult(this,r)}}),this.logger.info("Hooked NtCreateProcessEx")}handleNtCreateProcessExResult(e,t){try{let r=t.toInt32(),s;if(m(r))try{e.processHandle.isNull()||(s=e.processHandle.readPointer())}catch(c){this.logger.error(`Error reading process handle: ${c}`)}let n={processHandle:s,parentProcess:e.parentProcess,flags:e.flags,sectionHandle:e.sectionHandle,status:r,timestamp:new Date().toISOString()};this.logger.logProcessCreation("NtCreateProcessEx",n),this.eventSender.sendProcessCreation("NtCreateProcessEx",n)}catch(r){this.logger.error(`Error processing NtCreateProcessEx: ${r}`)}}};var u=class{sessionId;processName;processId;constructor(){this.sessionId=this.generateSessionId(),this.processName=Process.enumerateModules()[0].name,this.processId=Process.id,this.setupMessageHandlers(),this.sendMetadata()}sendFileOperation(e,t){let r={type:"file_operation",operation:e,data:{handle:t.handle.toString(),filePath:t.filePath,bytesTransferred:t.bytesTransferred,content:t.content,timestamp:t.timestamp},metadata:{sessionId:this.sessionId,processName:this.processName,processId:this.processId}};try{send(r)}catch(s){console.log(`[ERROR] Failed to send file operation event: ${s}`)}}sendProcessCreation(e,t){let r={type:"process_creation",operation:e,data:{processHandle:t.processHandle?.toString(),threadHandle:t.threadHandle?.toString(),imagePath:t.imagePath,commandLine:t.commandLine,currentDirectory:t.currentDirectory,parentProcess:t.parentProcess?.toString(),flags:t.flags,sectionHandle:t.sectionHandle?.toString(),status:t.status,timestamp:t.timestamp},metadata:{sessionId:this.sessionId,processName:this.processName,processId:this.processId}};try{send(r)}catch(s){console.log(`[ERROR] Failed to send process creation event: ${s}`)}}setupMessageHandlers(){recv("ping",e=>{send({type:"pong",timestamp:new Date().toISOString(),sessionId:this.sessionId})}),recv("config_update",e=>{console.log(`[INFO] Received config update: ${JSON.stringify(e)}`)}),recv("status",e=>{send({type:"status_response",data:{sessionId:this.sessionId,processName:this.processName,processId:this.processId,timestamp:new Date().toISOString(),status:"active"}})})}sendMetadata(){let e={type:"session_start",data:{sessionId:this.sessionId,processName:this.processName,processId:this.processId,timestamp:new Date().toISOString(),platform:Process.platform,arch:Process.arch}};try{send(e)}catch(t){console.log(`[ERROR] Failed to send metadata: ${t}`)}}generateSessionId(){let e=Date.now().toString(36),t=Math.random().toString(36).substring(2);return`${e}-${t}`}},f=new u;var g=class{logger;config;fileMonitor;processMonitor;constructor(e,t){this.config={enableFileOperations:!0,enableProcessCreation:!0,maxContentLength:256,logBinaryData:!1,...e},this.logger=t||new l,this.fileMonitor=new d(this.logger,this.config,f),this.processMonitor=new h(this.logger,this.config,f)}start(){this.logger.info("Starting Windows System Monitor"),this.logger.info(`Configuration: ${JSON.stringify(this.config,null,2)}`);try{this.fileMonitor.initialize(),this.processMonitor.initialize(),this.logger.info("System monitoring initialized successfully")}catch(e){throw this.logger.error(`Failed to initialize monitoring: ${e}`),e}}updateConfig(e){this.config={...this.config,...e},this.logger.info(`Configuration updated: ${JSON.stringify(this.config,null,2)}`)}getConfig(){return{...this.config}}};var I={enableFileOperations:!0,enableProcessCreation:!0,maxContentLength:512,logBinaryData:!1},H=new g(I);try{H.start()}catch(o){console.error(`Failed to start system monitor: ${o}`)}
